# Database Migrations with Liquibase

This project uses [Liquibase](https://www.liquibase.org/) to evolve the data schema via database migrations (changes to
the database schema).

The most common operations have shorthands and/or automations set up to make a normally _very_ painful or at least
delicate part of development more streamlined. Use this document for guidance on handling Model and DB Schema changes.

A strong developer experience uses code (backed by version control) as the source of truth. Model entities represented
by code have the added complexity of needing to also be in-line with the supporting database schema.

Using Spring Boot (specifically [Spring Data JPA](https://spring.io/projects/spring-data-jpa)), the server application
interfaces with the datastore in such a way that it tries to encapsulate database complexities, a trait common of modern
web development frameworks.

Combined, Liquibase and Spring allow code changes to translate into database changes with relatively minimal effort.

The main changelog file, [changelog.yaml](../server/src/main/resources/db/changelog/) is the entrypoint that liquibase
uses to look for un-applied migrations. It looks within the ['changes' directory](../server/src/main/resources/db/changelog/changes)
for individual migration scripts, which it will always attempt to apply in order, hence the timestamped naming
convention.

## Applying migrations locally

By default, migrations are applied when the app starts up, so all you need to do locally is build and run the app, and
migrations will be applied.

Sometimes, especially while making changes involving migrations, you might want to manually apply migrations to the
database without needing to start/stop or run the application at all. To do so, follow these steps:

1. Make sure your database is running
   ```
   make dev-db-up
   ```
1. Apply any missing migrations to your local database
   ```
   make server-migrate
   ```

## Generating migrations when updating model entities

[Model entities](../server/src/main/java/nj/lwd/ui/claimantintake/model) represent data stored in the application's
database. As a convenience, liquibase allows migrations to be generated by inspecting the database and comparing it to
the model entity code. Differences are packaged into migration scripts (yaml syntax).

To generate a migration alongside model entity changes, developers should follow these general steps:

1. Make sure the local datastore is up-to-date with existing migrations (See [Applying migrations locally](#applying-migrations-locally))
1. Make relevant code changes to model entities
1. Once your code changes look satisfactory, run
   ```
   make server-migration description="a_short_description_of_the_changes"
   ```
1. A migration file will be created in the ['changes' directory](../server/src/main/resources/db/changelog/changes),
   timestamped, and including a short description
1. Before applying the migration, it's good practice to inspect the generated file and verify that the changeset looks
   correct. You can also always have Liquibase print the SQL that it plans to execute for the migration using
   ```
   make server-migrate-dry-run
   ```
1. If everything looks good apply the migration(s) with
   ```
   make server-migrate
   ```

## Rolling back changes

There are [a number of ways to roll back migrations](https://docs.liquibase.com/commands/home.html#database-rollback-commands).
See also the [Liquibase rollback workflow documentation](https://docs.liquibase.com/workflows/liquibase-community/using-rollback.html).
Most commonly (but hopefully still rarely), you might need to roll back "n" most recently applied migrations. Keep in
mind, each change set corresponds to a row in the `databasechangelog` table. A single .yaml migration file
may contain multiple change sets.
To roll back several desired change sets, you can use the following convenience:

```
make server-rollback number_of_change_sets=n
```

If you prefer to see what changes Liquibase would perform before issuing the command, you can use

```
make server-rollback-dry-run number_of_change_sets=n
```
